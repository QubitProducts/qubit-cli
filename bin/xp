#!/usr/bin/env node
require('async-to-gen/register')
const path = require('path')
process.env.NODE_CONFIG_DIR = path.resolve(__dirname, '../config')
const program = require('commander')
const pkg = require('../package.json')
const exec = require('child_process').exec

program
  .command('login')
  .description('login to the platform')
  .action(createCmd('login'))

program
  .command('create <propertyId>')
  .description('create an experience')
  .action(createCmd('create'))

program
  .command('push')
  .description('push experience up to remote')
  .action(createCmd('push'))

program
  .command('pull')
  .usage(`
         xp pull // pull from remote
         xp pull example // pull from template
         xp pull propertyId experienceId // pull from experience
  `)
  .description('pull experience from template, remote or experience editor')
  .action(createCmd('pull'))

program
  .command('open')
  .description('open xp folder in finder, e.g. to locate chrome-extension')
  .action(() => exec(`open ${path.dirname(__dirname)}`))

program
  .command('preview-link')
  .description('log sharable preview links for your variations')
  .action(createCmd('preview-link'))

program
  .usage(`[variation.js] [options]
         xp <cmd> [options]`)
  .version(pkg.version)
  .arguments('<variation>')
  .option('-w, --watch', 'watch for changes and live reload')
  .option('-s, --sync', 'watch for changes and sync with remote')
  .option('-v, --verbose', 'log verbose output', false)
  .action(createCmd('serve'))

program.on('--help', function () {
  console.log(`
  Examples:

    $ xp --help

    $ xp login

    $ xp pull
    $ xp pull 2499 1234
    $ xp pull https://app.qubit.com/p/2499/experiences/84069/editor
    $ xp pull example

    $ xp create

    $ xp variation.js --watch
    $ xp variation.js --sync

    $ xp push
  `)
})

program.parse(process.argv)

function createCmd (name) {
  return function cmd () {
    return require(`../src/cmd/${name}`).apply(null, arguments)
  }
}
