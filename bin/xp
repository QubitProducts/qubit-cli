#!/usr/bin/env node
var program = require('commander')
var path = require('path')
var exec = require('child_process').exec
var pkg = require('../package.json')
var createServer = require('../src/server')
var getCerts = require('../src/server/lib/utils/https')
var scaffold = require('../src/server/lib/code/scaffold')
var read = require('../src/server/lib/code/read')
var log = require('../src/server/lib/utils/log')

program
  .command('open')
  .description('open xp folder in finder, e.g. to locate chrome-extension')
  .action(function () {
    exec(`open ${path.dirname(__dirname)}`)
  })

program
  .command('scaffold <template>')
  .description('scaffold a project from a template')
  .action(function templateScaffolding (template) {
    exec(`npm link ${template}`, {
      cwd: __dirname
    }, (err) => {
      if (err) return console.error(`could not find ${template} installed on your system`)
      read(path.dirname(require.resolve(template)))
        .then((codes) => {
          return scaffold(process.cwd(), codes, true, log)
        })
    })
  })

program
  .version(pkg.version)
  .option('-p, --port [port]', 'use custom [port]', Number, 1234)
  .option('-w, --wait', 'wait for window.__qubit.amd')
  .parse(process.argv)

if (!program.args.length) serve(program)

function serve (opts) {
  scaffold(process.cwd(), null, false, log)
  return getCerts()
    .then(function (certs) {
      opts.certs = certs
      return createServer(opts).listen(opts.port, () => {
        log(`xp listening on port ${opts.port}`)
      })
    })
}
